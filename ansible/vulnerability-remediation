---
- name: Security package vulnerability remediation automation for SUSE Linux
  hosts: localhost
  become_method: sudo
  become_user: root
  become: yes
  gather_facts: yes
  strategy: free

  vars:
    packages:
       - package-1
       - package-2

  tasks:
  - name: Check if the package version if installed
    shell: "rpm -qa | grep -i {{ item }}"
    register: installed_output
    ignore_errors: yes
    loop: "{{ packages }}"

  - name: Show package status installed or not
    debug:
      msg: >-
        {% if item.stdout %}                              # % % is used for cotrol statements, in this loop we are checking if a package is present in the 
          Package is installed: {{ item.stdout }}         # server it will store the output in stdout. if package is not present it will not store anything.
        {% else %}
          Package is not installed: {{ item.item }}
        {% endif %}
    loop: "{{ installed_output.results }}"
  
  - name: check if package in highest version or not
    shell: zypper info {{ item.item }} | egrep "Version|Status"
    register: version_status
    ignore_errors: yes
    loop: "{{ installed_output.results }}"
    when: item.stdout != ""

  - name: Output for version status
    debug:
      msg: version_status

  - name: Display package version comparison
    debug:
      msg: |
        Package: {{ item.item.item }}             #first item is from version_status 2nd item is from installed_output_results 3rd item is the package.
          {{ item.stdout }}
    loop: "{{ version_status.results }}"

  - name: Upgrading the instlled package
    zypper: 
       name: "{{ item.item }}"
       state: latest
    register: upgrade_status
    ignore_error: yes
    loop: "{{ installed_output.results }}"
    when: item.stdout != ""

  - name: Successfull Upgrades    #this block will show the packages upgraded to latest version
    debug:
       msg: " Package {{ item.item }} upgraded to latest version"
    when:
      - item.changed
      - not item.failed | default(false)
    loop: "{{ upgrade_status.results }}"

  - name: Failed Upgrades     #this block will show the packages which are not upgraded and if any errors.
    debug:
        msg: |
         Package {{ item.item }} failed to upgrade
         Error: {{ item.msg | default('Unknown error') }}
    when: item.failed | default(false)
    loop: "{{ upgrade_status.results }}"



    
